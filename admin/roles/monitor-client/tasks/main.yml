
- name: check if zabbix-release is available
  command: dpkg-query -W zabbix-release
  register: res
  failed_when: False

- name: download zabbix release packae
  get_url: 
      url="http://repo.zabbix.com/zabbix/3.2/ubuntu/pool/main/z/zabbix-release/zabbix-release_3.2-1+xenial_all.deb"
    dest="/tmp/zabbix-release.deb"
  when: res.rc == 1

- name: install zabbix-release.deb
  apt: deb="/tmp/zabbix-release.deb"
  when: res.rc == 1

- name: apt-get update
  apt: update_cache=yes
  when: res.rc == 1

- name: install zabbix-agent
  apt: name=zabbix-agent state=present

- name: configure zabbix-agent
  template: src="zabbix_agentd.conf" dest="/etc/zabbix/zabbix_agentd.conf"

- name: enable mdadm monitoring
  copy: src="zabbix_mdraid.conf" dest="/etc/zabbix/zabbix_agentd.d/zabbix_mdraid.conf" owner="root" mode=0640

- name: support scripts for mdadm monitoring
  copy: src="zabbix_mdraid.sh" dest="/usr/local/bin/zabbix_mdraid.sh" owner="root" mode=0755

- name: enable auto-start of zabbix-agent
  raw: systemctl enable zabbix-agent

- name: restart zabbix-agent
  service: name=zabbix-agent state=restarted


